# name: å¤šå¹³å°é•œåƒåŒæ­¥ï¼ˆç©ºæ ¼åˆ†éš”ç‰ˆï¼‰

# on:
#   workflow_dispatch:
#   schedule:
#     - cron: '0 */12 * * *'

# jobs:
#   sync:
#     runs-on: ubuntu-latest
#     steps:
#       - name: æ£€å‡ºä»£ç 
#         uses: actions/checkout@v4

#       - name: é…ç½®Docker Buildx
#         uses: docker/setup-buildx-action@v3

#       - name: ç™»å½•é•œåƒä»“åº“
#         run: |
#           docker login docker.cnb.cool -u cnb -p ${{ secrets.cnb }}

#       - name: åŒæ­¥å¤šå¹³å°é•œåƒ
#         run: |
#           set -eo pipefail
          
#           docker buildx create --name img_sync --use
#           docker buildx inspect --bootstrap

#           while IFS= read -r line; do
#             [[ "$line" =~ ^#|^$ ]] && continue

#             # è§£æè¾“å…¥è¡Œï¼ˆæ ¼å¼ï¼šæºé•œåƒ ç›®æ ‡é•œåƒ å¹³å°1 å¹³å°2 ...ï¼‰
#             src_image=$(echo "$line" | awk '{print $1}')
#             dest_image=$(echo "$line" | awk '{print $2}')
            
#             # æå–å¹³å°å‚æ•°ï¼ˆè·³è¿‡å‰ä¸¤åˆ—ï¼Œå‰©ä½™çš„éƒ½æ˜¯å¹³å°ï¼‰
#             platforms=$(echo "$line" | awk '{for(i=3;i<=NF;i++) printf "%s%s", (i>3?",":""), "linux/"$i}')
            
#             echo "ğŸ” æ­£åœ¨å¤„ç†: $src_image => $dest_image [å¹³å°: $platforms]"

#             # æ–¹æ³•1ï¼šä½¿ç”¨buildxåŒæ­¥ï¼ˆæ¨èï¼‰
#             echo "ğŸš€ ä½¿ç”¨buildxåŒæ­¥å¤šå¹³å°é•œåƒ..."
#             docker buildx build \
#               --platform "$platforms" \
#               --output=type=image,name=$dest_image,push=true \
#               --cache-from=type=registry,ref=$src_image \
#               - <<< "FROM $src_image"

#             echo "ğŸ‰ åŒæ­¥æˆåŠŸ: $dest_image"
#             echo "----------------------------------------"
#           done < "$GITHUB_WORKSPACE/images.txt"

#           docker buildx rm img_sync || true


name: å¤šå¹³å°é•œåƒåŒæ­¥ï¼ˆç®€å•ç‰ˆï¼‰

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */12 * * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Dockerç¯å¢ƒ
        uses: docker/setup-qemu-action@v3

      - name: è®¾ç½®Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½•é•œåƒä»“åº“
        run: |
          docker login docker.cnb.cool -u cnb -p ${{ secrets.cnb }}

      - name: åŒæ­¥é•œåƒ
        run: |
          set -eo pipefail
          
          while IFS= read -r line; do
            [[ "$line" =~ ^#|^$ ]] && continue

            # è§£æè¾“å…¥è¡Œï¼ˆæ ¼å¼ï¼šæºé•œåƒ ç›®æ ‡é•œåƒï¼‰
            src_image=$(echo "$line" | awk '{print $1}')
            dest_image=$(echo "$line" | awk '{print $2}')
            
            echo "ğŸ” æ­£åœ¨å¤„ç†: $src_image => $dest_image"

            # æ‹‰å–é•œåƒ
            echo "â¬‡ï¸ æ‹‰å–æºé•œåƒ..."
            docker pull $src_image

            # æ ‡è®°é•œåƒ
            echo "ğŸ·ï¸ æ ‡è®°é•œåƒ..."
            docker tag $src_image $dest_image

            # æ¨é€é•œåƒ
            echo "â¬†ï¸ æ¨é€ç›®æ ‡é•œåƒ..."
            docker push $dest_image

            echo "ğŸ‰ åŒæ­¥æˆåŠŸ: $dest_image"
            echo "----------------------------------------"
          done < "$GITHUB_WORKSPACE/images.txt"
